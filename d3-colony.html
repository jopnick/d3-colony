<!--
@license
MIT License

Copyright (c) 2017 Frank R.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<link rel="import" href="../paper-toast/paper-toast.html"/>
<link rel="import" href="import-d3.html"/>

<!--
`<d3-colony>` displays a dependency graph. Inspired by, and code (with modification)
copied from https://github.com/hughsk/colony

Example:

	<d3-colony nodes='[ { "name":"index.js", "group":0, "size":8 }, { "name":"index.js", "group":0, "size":8 }, { "name":"index.js", "size":3, "group":0 }, { "name":"d3", "size":5, "group":2 }, { "name":"mousetrap", "size":5, "group":16 }, { "name":"debounce", "size":5, "group":13 }, { "name":"resize.js", "size":3, "group":0 }, { "name":"highlight.js", "size":5, "group":14 }, { "name":"reqursive", "size":5, "group":20 }, { "name":"marked", "size":5, "group":17 }, { "name":"wrench", "size":5, "group":23 }, { "name":"utils.js", "size":3, "group":0 }, { "name":"async", "size":5, "group":1 }, { "name":"ejs", "size":5, "group":5 }, { "name":"jsdom", "size":5, "group":7 }, { "name":"sizzle", "size":5, "group":24 }, { "name":"d3.v2.js", "size":3, "group":2 }, { "name":"bash.js", "size":3, "group":14 }, { "name":"erlang.js", "size":3, "group":14 }, { "name":"cs.js", "size":3, "group":14 }, { "name":"ruby.js", "size":3, "group":14 }, { "name":"rust.js", "size":3, "group":14 }, { "name":"rib.js", "size":3, "group":14 }, { "name":"diff.js", "size":3, "group":14 }, { "name":"javascript.js", "size":3, "group":14 }, { "name":"glsl.js", "size":3, "group":14 }, { "name":"rsl.js", "size":3, "group":14 }, { "name":"lua.js", "size":3, "group":14 }, { "name":"xml.js", "size":3, "group":14 }, { "name":"markdown.js", "size":3, "group":14 }, { "name":"css.js", "size":3, "group":14 }, { "name":"lisp.js", "size":3, "group":14 }, { "name":"profile.js", "size":3, "group":14 }, { "name":"http.js", "size":3, "group":14 }, { "name":"java.js", "size":3, "group":14 }, { "name":"php.js", "size":3, "group":14 }, { "name":"haskell.js", "size":3, "group":14 }, { "name":"1c.js", "size":3, "group":14 }, { "name":"python.js", "size":3, "group":14 }, { "name":"smalltalk.js", "size":3, "group":14 }, { "name":"tex.js", "size":3, "group":14 }, { "name":"actionscript.js", "size":3, "group":14 }, { "name":"sql.js", "size":3, "group":14 }, { "name":"vala.js", "size":3, "group":14 }, { "name":"ini.js", "size":3, "group":14 }, { "name":"d.js", "size":3, "group":14 }, { "name":"axapta.js", "size":3, "group":14 }, { "name":"perl.js", "size":3, "group":14 }, { "name":"scala.js", "size":3, "group":14 }, { "name":"cmake.js", "size":3, "group":14 }, { "name":"objectivec.js", "size":3, "group":14 }, { "name":"avrasm.js", "size":3, "group":14 }, { "name":"vhdl.js", "size":3, "group":14 }, { "name":"coffeescript.js", "size":3, "group":14 }, { "name":"nginx.js", "size":3, "group":14 }, { "name":"erlang-repl.js", "size":3, "group":14 }, { "name":"r.js", "size":3, "group":14 }, { "name":"json.js", "size":3, "group":14 }, { "name":"django.js", "size":3, "group":14 }, { "name":"delphi.js", "size":3, "group":14 }, { "name":"vbscript.js", "size":3, "group":14 }, { "name":"mel.js", "size":3, "group":14 }, { "name":"dos.js", "size":3, "group":14 }, { "name":"apache.js", "size":3, "group":14 }, { "name":"cpp.js", "size":3, "group":14 }, { "name":"matlab.js", "size":3, "group":14 }, { "name":"parser3.js", "size":3, "group":14 }, { "name":"clojure.js", "size":3, "group":14 }, { "name":"go.js", "size":3, "group":14 }, { "name":"detective", "size":5, "group":3 }, { "name":"nub", "size":5, "group":4 }, { "name":"async.js", "size":3, "group":1 }, { "name":"utils.js", "size":3, "group":5 }, { "name":"filters.js", "size":3, "group":5 }, { "name":"index.js", "size":3, "group":7 }, { "name":"documentfeatures.js", "size":3, "group":7 }, { "name":"request", "size":5, "group":21 }, { "name":"style.js", "size":3, "group":7 }, { "name":"index.js", "size":3, "group":7 }, { "name":"index.js", "size":3, "group":7 }, { "name":"esprima", "size":5, "group":6 }, { "name":"core.js", "size":3, "group":7 }, { "name":"xpath.js", "size":3, "group":7 }, { "name":"events.js", "size":3, "group":7 }, { "name":"html.js", "size":3, "group":7 }, { "name":"ls.js", "size":3, "group":7 }, { "name":"oauth.js", "size":3, "group":21 }, { "name":"uuid.js", "size":3, "group":21 }, { "name":"forever.js", "size":3, "group":21 }, { "name":"index.js", "size":3, "group":21 }, { "name":"jar.js", "size":3, "group":21 }, { "name":"tunnel.js", "size":3, "group":21 }, { "name":"aws.js", "size":3, "group":21 }, { "name":"mime", "size":5, "group":18 }, { "name":"form-data", "size":5, "group":19 }, { "name":"core.js", "size":3, "group":7 }, { "name":"html.js", "size":3, "group":7 }, { "name":"utils.js", "size":3, "group":7 }, { "name":"cssom", "size":5, "group":8 }, { "name":"htmltodom.js", "size":3, "group":7 }, { "name":"domtohtml.js", "size":3, "group":7 }, { "name":"htmlencoding.js", "size":3, "group":7 }, { "name":"contextify", "size":5, "group":9 }, { "name":"htmlparser", "size":5, "group":15 }, { "name":"sizzle.js", "size":3, "group":7 }, { "name":"events.js", "size":3, "group":7 }, { "name":"combined-stream", "size":5, "group":10 }, { "name":"async", "size":5, "group":1 }, { "name":"core.js", "size":3, "group":7 }, { "name":"CSSStyleDeclaration.js", "size":3, "group":8 }, { "name":"CSSRule.js", "size":3, "group":8 }, { "name":"CSSStyleRule.js", "size":3, "group":8 }, { "name":"MediaList.js", "size":3, "group":8 }, { "name":"CSSMediaRule.js", "size":3, "group":8 }, { "name":"CSSImportRule.js", "size":3, "group":8 }, { "name":"CSSFontFaceRule.js", "size":3, "group":8 }, { "name":"StyleSheet.js", "size":3, "group":8 }, { "name":"CSSStyleSheet.js", "size":3, "group":8 }, { "name":"CSSKeyframesRule.js", "size":3, "group":8 }, { "name":"CSSKeyframeRule.js", "size":3, "group":8 }, { "name":"parse.js", "size":3, "group":8 }, { "name":"clone.js", "size":3, "group":8 }, { "name":"bindings", "size":5, "group":11 }, { "name":"delayed-stream", "size":5, "group":12 }, { "name":"async.js", "size":3, "group":1 } ]'
			   links='[ { "source":0, "target":2 }, { "source":1, "target":3 }, { "source":1, "target":4 }, { "source":1, "target":5 }, { "source":1, "target":6 }, { "source":2, "target":7 }, { "source":2, "target":8 }, { "source":2, "target":9 }, { "source":2, "target":10 }, { "source":11, "target":10 }, { "source":2, "target":11 }, { "source":2, "target":12 }, { "source":8, "target":12 }, { "source":2, "target":13 }, { "source":3, "target":14 }, { "source":78, "target":14 }, { "source":3, "target":15 }, { "source":3, "target":16 }, { "source":7, "target":17 }, { "source":7, "target":18 }, { "source":7, "target":19 }, { "source":7, "target":20 }, { "source":7, "target":21 }, { "source":7, "target":22 }, { "source":7, "target":23 }, { "source":7, "target":24 }, { "source":7, "target":25 }, { "source":7, "target":26 }, { "source":7, "target":27 }, { "source":7, "target":28 }, { "source":7, "target":29 }, { "source":7, "target":30 }, { "source":7, "target":31 }, { "source":7, "target":32 }, { "source":7, "target":33 }, { "source":7, "target":34 }, { "source":7, "target":35 }, { "source":7, "target":36 }, { "source":7, "target":37 }, { "source":7, "target":38 }, { "source":7, "target":39 }, { "source":7, "target":40 }, { "source":7, "target":41 }, { "source":7, "target":42 }, { "source":7, "target":43 }, { "source":7, "target":44 }, { "source":7, "target":45 }, { "source":7, "target":46 }, { "source":7, "target":47 }, { "source":7, "target":48 }, { "source":7, "target":49 }, { "source":7, "target":50 }, { "source":7, "target":51 }, { "source":7, "target":52 }, { "source":7, "target":53 }, { "source":7, "target":54 }, { "source":7, "target":55 }, { "source":7, "target":56 }, { "source":7, "target":57 }, { "source":7, "target":58 }, { "source":7, "target":59 }, { "source":7, "target":60 }, { "source":7, "target":61 }, { "source":7, "target":62 }, { "source":7, "target":63 }, { "source":7, "target":64 }, { "source":7, "target":65 }, { "source":7, "target":66 }, { "source":7, "target":67 }, { "source":7, "target":68 }, { "source":8, "target":69 }, { "source":8, "target":70 }, { "source":12, "target":71 }, { "source":13, "target":72 }, { "source":13, "target":73 }, { "source":14, "target":74 }, { "source":14, "target":75 }, { "source":14, "target":76 }, { "source":14, "target":77 }, { "source":14, "target":78 }, { "source":14, "target":79 }, { "source":69, "target":80 }, { "source":74, "target":81 }, { "source":82, "target":81 }, { "source":84, "target":81 }, { "source":85, "target":81 }, { "source":74, "target":82 }, { "source":74, "target":83 }, { "source":85, "target":83 }, { "source":74, "target":84 }, { "source":74, "target":85 }, { "source":76, "target":86 }, { "source":76, "target":87 }, { "source":76, "target":88 }, { "source":76, "target":89 }, { "source":76, "target":90 }, { "source":76, "target":91 }, { "source":76, "target":92 }, { "source":76, "target":93 }, { "source":94, "target":93 }, { "source":76, "target":94 }, { "source":77, "target":95 }, { "source":81, "target":95 }, { "source":105, "target":95 }, { "source":77, "target":96 }, { "source":84, "target":96 }, { "source":77, "target":97 }, { "source":105, "target":97 }, { "source":77, "target":98 }, { "source":78, "target":99 }, { "source":81, "target":99 }, { "source":78, "target":100 }, { "source":81, "target":100 }, { "source":78, "target":101 }, { "source":81, "target":101 }, { "source":99, "target":101 }, { "source":100, "target":101 }, { "source":78, "target":102 }, { "source":78, "target":103 }, { "source":79, "target":104 }, { "source":83, "target":105 }, { "source":94, "target":106 }, { "source":94, "target":107 }, { "source":95, "target":108 }, { "source":98, "target":109 }, { "source":111, "target":109 }, { "source":115, "target":109 }, { "source":119, "target":109 }, { "source":120, "target":109 }, { "source":121, "target":109 }, { "source":98, "target":110 }, { "source":111, "target":110 }, { "source":113, "target":110 }, { "source":114, "target":110 }, { "source":115, "target":110 }, { "source":118, "target":110 }, { "source":119, "target":110 }, { "source":98, "target":111 }, { "source":117, "target":111 }, { "source":120, "target":111 }, { "source":121, "target":111 }, { "source":98, "target":112 }, { "source":113, "target":112 }, { "source":114, "target":112 }, { "source":98, "target":113 }, { "source":120, "target":113 }, { "source":121, "target":113 }, { "source":98, "target":114 }, { "source":120, "target":114 }, { "source":98, "target":115 }, { "source":120, "target":115 }, { "source":98, "target":116 }, { "source":117, "target":116 }, { "source":98, "target":117 }, { "source":114, "target":117 }, { "source":120, "target":117 }, { "source":121, "target":117 }, { "source":98, "target":118 }, { "source":120, "target":118 }, { "source":121, "target":118 }, { "source":98, "target":119 }, { "source":120, "target":119 }, { "source":121, "target":119 }, { "source":98, "target":120 }, { "source":109, "target":120 }, { "source":117, "target":120 }, { "source":98, "target":121 }, { "source":102, "target":122 }, { "source":106, "target":123 }, { "source":107, "target":124 } ]'
			   loaded></d3-colony>

@group D3 Elements
@element d3-colony
@demo demo/index.html
@hero hero.svg
-->

<dom-module id="d3-colony">
	<template>
		<style>
			#container {
				background-color: #252929;
			}
		</style>
		<div id="container"></div>
		<!-- TODO color and size legend -->
		<!-- TODO node count, and other stats? -->
		<paper-toast id="message" duration="Infinity"></paper-toast>
	</template>
	<script>
		class D3Colony extends Polymer.Element {
			static get is() { return "d3-colony"; }

			static get properties() {
				return {
					/**
					 * An array of nodes
					 */
					nodes: {
						type: Array,
						value: function() { return []; },
					},
					/**
					 * An array of links (dependencies)
					 */
					links: {
						type: Array,
						value: function() { return []; },
					},
					/**
					 * Scale of the graph
					 */
					scale: {
						type: Number,
						value: 1,
					},
					/**
					 * Width of the graph
					 */
					width: {
						type: Number,
						value: 600,
					},
					/**
					 * Height of the graph
					 */
					height: {
						type: Number,
						value: 400,
					},
					/**
					 * Definition of node colors
					 */
					colors: {
						type: Object,
						value: function() {
							var self = this;

							return {
								links: '#FAFAFA',
								text: {
									subtitle: '#FAFAFA',
								},
								nodes: {
									method: function(d) {
										return self.colorLookup[d.group];
									},
									hover: '#FAFAFA',
									dep: '#252929',
								},
							};
						},
					},
					/**
					 * Scale of the graph
					 */
					selected: {
						type: String,
						notify: true,
						observer: "selectedObserver",
					},
					/**
					 * Indicator of whether it is ready for render the graph
					 */
					loaded: {
						type: Boolean,
						value: false,
					}
				};
			}

			static get observers() {
				return [
					"colonyObserver(links, nodes, scale, colors)",
					"refresh(width, height)",
				];
			}

			ready() {
				super.ready();

				var self = this;
				self.$.message.fitInto = self.$.container;
			}

			colonyObserver(links, nodes, scale, colors) {
				var self = this;

				if (!self.loaded) {
					return;
				}

				/*
				 * name => node
				 */
				self.nodeLookup = {};
				for (var node of nodes) {
					self.nodeLookup[node.name] = node;
				}

				links.forEach(function(link) {
					var source = nodes[link.source];
					var target = nodes[link.target];

					source.children = source.children || [];
					source.children.push(link.target);

					target.parents = target.parents || [];
					target.parents.push(link.source);
				})

				var groups = nodes.reduce(function(groups, node) {
					var group = node.group || 0;
					if (groups.indexOf(group) == -1) {
						groups.push(group);
					}
					return groups;
				}, []);

				/*
				 * https://stackoverflow.com/questions/1063007/how-to-sort-an-array-of-integers-correctly
				 */
				groups.sort(function(a, b) {
					return b - a;
				});

				/*
				 * https://bl.ocks.org/syntagmatic/fda03bb0e99febe49fca0fe63f5ca55e
				 */
				//var color = d3.scale.linear()
				//	.range(["yellow", "purple", "green"])
				//	.domain([0, groups.length / 2, groups.length])
				//	.interpolate(d3.interpolateHsl);

				self.colorLookup = groups.reduce(function(colorLookup, group, n) {
					var color = d3.hsl(n / groups.length * 240, 0.7, 0.725);
					colorLookup[group] = color.toString();
					//colorLookup[group] = color(n).toString();
					return colorLookup;
				}, {});

				self.force = d3.layout.force()
					.size([self.width, self.height])
					.charge(-50 * self.scale)
					.linkDistance(function(l) {
						return (20 + l.source.size + l.target.size) * self.scale;
					})
					.on('tick', function() {
						self.link.attr('x1', function(d) { return d.source.x; })
							.attr('y1', function(d) { return d.source.y; })
							.attr('x2', function(d) { return d.target.x; })
							.attr('y2', function(d) { return d.target.y; })

						self.node.attr('cx', function(d) { return d.x; })
							.attr('cy', function(d) { return d.y; })

						//if (textTarget) {
						//	text.attr('transform'
						//			, 'translate(' + textTarget.x + ',' + textTarget.y + ')')
						//}
					});

				/*
				 * https://stackoverflow.com/questions/10784018/how-can-i-remove-or-replace-svg-content
				 */
				self.vis = d3.select(self.$.container).select("svg").remove();
				self.vis = d3.select(self.$.container)
					.append('svg')
					.attr('width', self.width)
					.attr('height', self.height);

				self.force.nodes(nodes)
					 .links(links)
					 .start();

				self.link = self.vis.selectAll('line.link').data(links);
				self.node = self.vis.selectAll('circle.node')
					.data(nodes, function(d) { return d.filename });

				self.link.enter()
					.insert('line', '.node')
					.attr('class', 'link')
					.attr('x1', function(d) { return d.source.x; })
					.attr('y1', function(d) { return d.source.y; })
					.attr('x2', function(d) { return d.target.x; })
					.attr('y2', function(d) { return d.target.y; })
					.style('stroke', colors.links)
					.style('opacity', function(d) {
						return d.target.module ? 0.2 : 0.3;
					});

				self.node.enter()
					.append('circle')
					.attr('class', 'node')
					.attr('cx', function(d) { return d.x })
					.attr('cy', function(d) { return d.y })
					.attr('r', function(d) {
						return scale * d.size;
					})
					.style('fill', colors.nodes.method)
					.call(self.force.drag)
					.on('mouseover', function(d) {
						//textTarget = d
						//
						//text.attr('transform', 'translate(' + d.x + ',' + d.y + ')')
						//	.text(d.name)
						//	.style('display', null)
						self.$.message.text = d.name + ": group " + d.group + ", size " + d.size;
						self.$.message.open();

						d3.select(this)
						  .style('fill', colors.nodes.hover)

						d3.selectAll(self.childNodes(d))
							.style('fill', colors.nodes.hover)
							.style('stroke', colors.nodes.method)
							.style('stroke-width', 2)

						d3.selectAll(self.parentNodes(d))
							.style('fill', colors.nodes.dep)
							.style('stroke', colors.nodes.method)
							.style('stroke-width', 2)
					})
					.on('mouseout', function(d) {
						//textTarget = false
						//
						//text.style('display', 'none')
						self.$.message.text = "";
						self.$.message.close();

						d3.select(this)
						  .style('fill', colors.nodes.method)

						d3.selectAll(self.childNodes(d))
							.style('fill', colors.nodes.method)
							.style('stroke', null)

						d3.selectAll(self.parentNodes(d))
							.style('fill', colors.nodes.method)
							.style('stroke', null)
					})
					.on('click', function(d) {
						self.toggleFocus(d, false);
					});

				//text = self.vis.selectAll('.nodetext')
				//	.data([
				//		  [-1.5,  1.5,  1] // "Shadows"
				//		, [ 1.5,  1.5,  1]
				//		, [-1.5, -1.5,  1]
				//		, [ 1.5, -1.5,  1]
				//		, [ 0.0,  0.0,  0] // Actual Text
				//	])
				//	.enter()
				//	.insert('text', ':last-child')
				//	.attr('class', 'nodetext')
				//	.classed('shadow', function(d) { return d[2] })
				//	.attr('dy', function(d) { return d[0] - 10 })
				//	.attr('dx', function(d) { return d[1] })
				//	.attr('text-anchor', 'middle');

				self.selectedObserver(self.selected, undefined);
			}

			selectedObserver(newValue, oldValue) {
				var self = this;
				if (!self.loaded) {
					return;
				}
				if (self.internal) {
					self.internal = false;
					return;
				}

				console.log("<d3-colony> selectedObserver: " + oldValue + " => " + newValue);

				if (oldValue) {
					var node = self.nodeLookup[oldValue];
					if (node) {
						self.toggleFocus(node, true);
					}
				}

				if (newValue) {
					var node = self.nodeLookup[newValue];
					if (node) {
						self.toggleFocus(node, true);
					} else {
						self.$.message.text = "Not found: " + newValue;
						self.$.message.open();
					}
				}
			}

			toggleFocus(d, internal) {
				var self = this;

				if (self.focus === d) {
					self.force.charge(-50 * self.scale)
						.linkDistance(function(l) {
							return (20 + l.source.size + l.target.size) * self.scale;
						})
						.linkStrength(1)
						.start();

					self.node.style('opacity', 1)
					self.link.style('opacity', function(d) {
						return d.target.module ? 0.2 : 0.3;
					});

					console.log("<d3-colony> toggleFocus: blur on " + d.name);
					if (!internal) {
						self.setProperties({
							selected: undefined,
							internal: true,
						});
					}
					self.focus = undefined;

					//d3.select('#readme-contents')
					//	.html(readme)
					//	.classed('showing-code', false);

					return;
				}

				console.log("<d3-colony> toggleFocus: focus on " + d.name);
				if (!internal) {
					self.setProperties({
						selected: d.name,
						internal: true,
					});
				}
				self.focus = d;

				//d3.xhr('./files/' + d.filename + '.html', function(res) {
				//	if (!res) return
				//
				//	d3.select('#readme-contents')
				//		.html(res.responseText)
				//		.classed('showing-code', true)
				//
				//	document.getElementById('readme')
				//			.scrollTop = 0
				//});

				self.node.style('opacity', function(o) {
					o.active = self.connected(d, o);
					return o.active ? 1 : 0.2;
				});

				self.force.charge(function(o) {
					return (o.active ? -100 : -5) * self.scale;
				}).linkDistance(function(l) {
					return ((l.source.active && l.target.active ? 100 : 20) + l.source.size + l.target.size) * self.scale;
				}).linkStrength(function(l) {
					return (l.source === d || l.target === d ? 1 : 0) * self.scale;
				}).start();

				self.link.style('opacity', function(l, i) {
					return l.source.active && l.target.active ? 0.2 : 0.02;
				});
			}

			refresh(width, height) {
				var self = this;

				if (!self.loaded) {
					return;
				}

				self.force.size([width, height])
					.resume();
				self.vis.attr('width', width)
					.attr('height', height);
			};

			childNodes(d) {
				if (!d.children) return [];

				var self = this;

				return d.children
					.map(function(child) {
						return self.node[0][child];
					}).filter(function(child) {
						return child;
					})
			};

			parentNodes(d) {
				if (!d.parents) return []

				var self = this;

				return d.parents
					.map(function(parent) {
						return self.node[0][parent];
					}).filter(function(parent) {
						return parent;
					})
			};

			connected(d, o) {
				var self = this;
				var oIndex = self.nodes.indexOf(o);
				var dIndex = self.nodes.indexOf(d);
				return oIndex === dIndex ||
					(d.children && d.children.indexOf(oIndex) !== -1) ||
					(o.children && o.children.indexOf(dIndex) !== -1) ||
					(o.parents && o.parents.indexOf(dIndex) !== -1) ||
					(d.parents && d.parents.indexOf(oIndex) !== -1)
			};
		}

		window.customElements.define(D3Colony.is, D3Colony);
	</script>
</dom-module>